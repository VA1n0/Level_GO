<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Level GO ‚Äî Ratne</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body { height: 100%; margin: 0; background:#0b0b0b; font-family: system-ui, Arial; }
    #map { height: 100%; width: 100%; }

    .hud {
      position: fixed;
      z-index: 9999;
      display: flex;
      gap: 8px;
      left: 10px;
      top: 10px;
    }
    .hud button{
      background:#111;
      color:#fff;
      border:1px solid rgba(255,255,255,.15);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
    }
    .hud button:active{ transform: scale(.98); }

    #apiStatus{
      position: fixed;
      left: 10px;
      bottom: 10px;
      background:#111;
      color:#fff;
      padding:6px 10px;
      border-radius:10px;
      font-size:12px;
      z-index:9999;
      opacity:.92;
      border:1px solid rgba(255,255,255,.12);
    }

    #invBox{
      position: fixed;
      right: 10px;
      bottom: 10px;
      background:#111;
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      font-size:12px;
      z-index:9999;
      min-width:180px;
      opacity:.92;
      border:1px solid rgba(255,255,255,.12);
    }

    .leaflet-popup-content button{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.15);
      background:#0f172a;
      color:#fff;
      font-weight:700;
      cursor:pointer;
    }
  </style>
</head>
<body>

  <div id="map"></div>

  <div class="hud">
    <button id="btnHere">üìç –Ø —Ç—É—Ç</button>
    <button id="btnRefresh">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
    <button id="btnSpawn">‚ú® Spawn (—Ç–µ—Å—Ç)</button>
  </div>

  <div id="apiStatus">API: ...</div>
  <div id="invBox">–Ü–Ω–≤–µ–Ω—Ç–∞—Ä: ...</div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Telegram WebApp (–Ω–µ –∑–∞–≤–∞–∂–∞—î —è–∫—â–æ –≤—ñ–¥–∫—Ä–∏–≤–∞—Ç–∏ –ø—Ä–æ—Å—Ç–æ –≤ –±—Ä–∞—É–∑–µ—Ä—ñ) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script>
    // üîß –¢–£–¢ –ø–æ—Å—Ç–∞–≤ —Å–≤—ñ–π Railway URL
    const API_BASE = "https://web-production-f2d5a.up.railway.app";

    const RATNE_CENTER = [51.671708, 24.524050];

    const USER_ID_KEY = "level_go_user_id";

    function getUserId() {
      let id = localStorage.getItem(USER_ID_KEY);
      if (!id) {
        id = "u_" + Math.random().toString(16).slice(2) + "_" + Date.now();
        localStorage.setItem(USER_ID_KEY, id);
      }
      return id;
    }

    async function apiGet(path) {
      const r = await fetch(API_BASE + path);
      return r.json();
    }

    async function apiPost(path, body) {
      const r = await fetch(API_BASE + path, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(body)
      });
      return r.json();
    }

    function setApiStatus(ok) {
      const el = document.getElementById("apiStatus");
      el.textContent = ok ? "API: online" : "API: offline";
    }

    function setInv(inv, rewards) {
      const el = document.getElementById("invBox");
      const disc = rewards?.discount_percent ?? 0;
      el.innerHTML = `
        <div><b>Level GO ‚Äî Ratne</b></div>
        <div style="opacity:.8">user: ${getUserId()}</div>
        <hr style="opacity:.2"/>
        <div>üåæ –∑–µ—Ä–Ω–æ: <b>${inv["–∑–µ—Ä–Ω–æ"] ?? 0}</b></div>
        <div>ü•ê –∫—Ä—É–∞—Å–∞–Ω: <b>${inv["–∫—Ä—É–∞—Å–∞–Ω"] ?? 0}</b></div>
        <div>üèÜ –∑–æ–ª–æ—Ç–∞ —á–∞—à–∫–∞: <b>${inv["–∑–æ–ª–æ—Ç–∞ —á–∞—à–∫–∞"] ?? 0}</b></div>
        <hr style="opacity:.2"/>
        <div><b>–ë–æ–Ω—É—Å:</b> ${disc ? ("-" + disc + "%") : "–ø–æ–∫–∏ –Ω–µ–º–∞—î"}</div>
        <div style="opacity:.7;font-size:11px;margin-top:6px">
          –ó–±—ñ—Ä –ø—Ä–∞—Ü—é—î —è–∫—â–æ —Ç–∏ –±–ª–∏–∂—á–µ 30–º –¥–æ –¥—Ä–æ–ø–∞.
        </div>
      `;
    }

    // --- Map init ---
    const map = L.map("map", { zoomControl: true }).setView(RATNE_CENTER, 14);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    let currentPos = null;
    let meMarker = null;
    let dropMarkers = [];

    function setMeMarker(lat, lon) {
      if (!meMarker) {
        meMarker = L.circleMarker([lat, lon], {
          radius: 8,
          weight: 2,
          fillOpacity: 0.8
        }).addTo(map);
        meMarker.bindPopup("–Ø —Ç—É—Ç");
      } else {
        meMarker.setLatLng([lat, lon]);
      }
    }

    async function refreshMe() {
      try {
        const me = await apiGet(`/me?user_id=${encodeURIComponent(getUserId())}`);
        setInv(me.inv, me.rewards);
      } catch (e) {
        console.error(e);
      }
    }

    async function refreshDrops() {
      try {
        const data = await apiGet("/drops");
        setApiStatus(true);

        dropMarkers.forEach(m => m.remove());
        dropMarkers = [];

        (data.drops || []).forEach(d => {
          const marker = L.marker([d.lat, d.lon]).addTo(map);

          marker.bindPopup(`
            <div style="min-width:190px">
              <div><b>–î—Ä–æ–ø:</b> ${d.type}</div>
              <div style="opacity:.8">id: ${d.id}</div>
              <button id="btnCollect_${d.id}" style="margin-top:8px">–ó—ñ–±—Ä–∞—Ç–∏</button>
            </div>
          `);

          marker.on("popupopen", () => {
            const btn = document.getElementById(`btnCollect_${d.id}`);
            if (!btn) return;

            btn.onclick = async () => {
              if (!currentPos) {
                alert("–ù–µ–º–∞—î –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó. –ù–∞—Ç–∏—Å–Ω–∏ üìç –Ø —Ç—É—Ç.");
                return;
              }
              const res = await apiPost("/collect", {
                user_id: getUserId(),
                drop_id: d.id,
                lat: currentPos.lat,
                lon: currentPos.lon
              });

              if (res.ok) {
                alert(`‚úÖ –ó—ñ–±—Ä–∞–Ω–æ: ${res.collected.type}\n–í—ñ–¥—Å—Ç–∞–Ω—å: ${res.distance_m}–º`);
                await refreshMe();
                await refreshDrops();
              } else {
                if (res.reason === "too_far") {
                  alert(`‚ùå –î–∞–ª–µ–∫–æ. ${res.distance_m}–º (—Ç—Ä–µ–±–∞ –¥–æ ${res.pickup_radius_m}–º)`);
                } else {
                  alert("‚ùå –ù–µ –≤–∏–π—à–ª–æ: " + res.reason);
                }
              }
            };
          });

          dropMarkers.push(marker);
        });

      } catch (e) {
        setApiStatus(false);
        console.error(e);
      }
    }

    async function setHere() {
      if (!navigator.geolocation) {
        alert("Geolocation –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è");
        return;
      }
      navigator.geolocation.getCurrentPosition((pos) => {
        currentPos = { lat: pos.coords.latitude, lon: pos.coords.longitude };
        setMeMarker(currentPos.lat, currentPos.lon);
        map.setView([currentPos.lat, currentPos.lon], 16);
      }, (err) => {
        alert("–ù–µ –¥–∞–≤ –¥–æ—Å—Ç—É–ø –¥–æ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó: " + err.message);
      }, { enableHighAccuracy: true, timeout: 8000 });
    }

    async function spawnTest() {
      try {
        const r = await apiGet("/spawn");
        alert(`Spawned: ${r.count} —Ç–æ—á–æ–∫`);
        await refreshDrops();
      } catch (e) {
        alert("Spawn –Ω–µ –≤–∏–π—à–æ–≤. –ü–µ—Ä–µ–≤—ñ—Ä API.");
      }
    }

    // Buttons
    document.getElementById("btnHere").onclick = setHere;
    document.getElementById("btnRefresh").onclick = refreshDrops;
    document.getElementById("btnSpawn").onclick = spawnTest;

    // Telegram WebApp polish
    try {
      if (window.Telegram?.WebApp) {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
      }
    } catch {}

    // Init
    (async () => {
      await refreshMe();
      await refreshDrops();
    })();
  </script>
</body>
</html>